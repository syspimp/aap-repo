- hosts: builder*
  vars:
    EE_TYPE: "hybrid"
    VERBOSE: 3
    USE_CACHE: "--no-cache"
    TAG: "{{ EE_TYPE }}z7:latest"
    UPSTREAM_REPO: docker.io/syspimp/ansible-ee
    UPSTREAM_TAG: "{{ EE_TYPE }}"
  tasks:
  - name: "Check for 10 mins if ansible.cfg file exists in playbook dir"
    stat:
      path: "/opt/aap-repo/execution-environments/{{ EE_TYPE }}/ansible.cfg"
    retries: 10
    delay: 60
    until: playconfig.stat.exists == true
    register: playconfig

  - name: "Fail when ansible.cfg not configured"
    ansible.builtin.fail:
      msg: "You need to read and configure /opt/aap-repo/execution-environents/{{ EE_TYPE }}/ansible.cfg"
    when: playconfig.stat.exists == false

  - name: "**Building the image" 
    environment:
      subuser: "{{ SUBUSER }}"
      subpass: "{{ SUBPASS }}"
    shell: |
      podman login -u "${subuser}" -p "${subpass}" registry.redhat.io
      ansible-builder build -t {{ TAG }} -v {{ VERBOSE }} {{ USE_CACHE }}
    args:
      chdir: "/opt/aap-repo/execution-environments/{{ EE_TYPE }}"

  - name: "**tagging the container image"
    shell: |
      podman tag localhost/{{ TAG }} {{ UPSTREAM_REPO }}:{{ UPSTREAM_TAG }}
    args:
      chdir: "/opt/aap-repo/execution-environments/{{ EE_TYPE }}"

  - name: "**Pushing to the cloud..."
    environment:
      dockeruser: "{{ DOCKERUSER }}"
      dockerpass: "{{ DOCKERPASS }}"
    shell: |
      podman login -u "${dockeruser}" -p "${dockerpass}" docker.io
      podman push {{ UPSTREAM_REPO }}:{{ UPSTREAM_TAG }}
    args:
      chdir: "/opt/aap-repo/execution-environments/{{ EE_TYPE }}"

