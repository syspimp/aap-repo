---
- hosts: all
  become: yes
  vars:
    newusername: ansiblesvc
    newgroups: "wheel,root"
    # provide path to a public keyfile or paste in the pub key
    public_key: lookup('file', '/home/dataylor/ansiblesvc.pub')
    #public_key: "ssh-rsa AAAAB3Nz ...blah... 03Ug30uAv8= you@there.com"
  tasks:
  - name: error handling
    block:
    - name: "Add the automation user '{{ newusername }}'"
      user:
        name: "{{ newusername }}"
        comment: "Built By Ansible Automation"
        groups: "{{ newgroups }}"
        append: yes

    rescue:
    - name: "Ubuntu: Add the automation user '{{ newusername }}'"
      user:
        name: "{{ newusername }}"
        comment: "Built By Ansible Automation"
        groups: "{{ newgroups.replace('wheel','sudo') }}"
        append: yes

  - name: Set authorized key taken from file
    ansible.posix.authorized_key:
      user: "{{ newusername }}"
      state: present
      key: "{{ public_key }}"

  - name:
    template:
      src: "{{ newusername }}.j2"
      dest: "/etc/sudoers.d/{{ newusername }}"
      owner: root
      group: root
      mode: '0440'

